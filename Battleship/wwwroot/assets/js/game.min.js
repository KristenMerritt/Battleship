function Cell(n,t,i,r,u){this.parent=n;this.id=t;this.size=i;this.row=r;this.col=u;this.shipPiece="";this.y=this.size*this.row;this.x=this.size*this.col;this.droppable=!0;this.object=this.create();this.parent.appendChild(this.object);this.myBBox=this.getMyBBox()}function Hole(n,t,i,r,u,f,e){this.parent=n;this.id=t;this.size=i;this.row=r;this.col=u;this.cy=f;this.cx=e;this.occupied="empty";this.hit=!1;this.object=this.create();this.parent.appendChild(this.object);this.myBBox=this.getMyBBox()}function ShipPiece(n,t,i,r,u){return this.parent=n,this.row=t,this.col=i,this.number=r,this.isHit=u,this.parentType=this.parent.getAttribute("type"),this.id=this.parentType+"_piece_"+this.number,this.piece=document.createElementNS(game.svgns,"rect"),this.piece.setAttributeNS(null,"id",this.parentType+"_piece_"+this.number),this.piece.setAttributeNS(null,"transform","translate("+this.row*50+","+this.col*50+")"),this.piece.setAttributeNS(null,"height","50px"),this.piece.setAttributeNS(null,"width","50px"),this.isHit?this.piece.setAttributeNS(null,"fill","red"):this.piece.setAttributeNS(null,"fill","white"),this.piece.setAttribute("row",t),this.piece.setAttribute("col",i),this.piece.addEventListener("mousedown",function(){drag.setMove(this.parentElement.getAttribute("type"))},!1),document.getElementById("g_"+this.parentType).appendChild(this.piece),this}function Ship(n,t,i,r,u){return this.parent=n,this.type=t,this.isPlaced=r,this.isSunk=u,this.id="g_"+this.type,this.shipPieces=i,this.object=new window[t](this),this.g=this.object.g,this.setAtt("id",this.id),document.getElementsByTagName("svg")[0].appendChild(this.g),this}function Carrier(n){return this.parent=n,this.g=document.createElementNS(game.svgns,"g"),this.shipPieces=this.parent.shipPieces,this.length=5,this.firstPiece=this.shipPieces[0],this.lastPiece=this.shipPieces[length],this.g.setAttributeNS(null,"id","g_Carrier"),this.g.setAttributeNS(null,"width",this.length*50+"px"),this.g.setAttributeNS(null,"height","50px"),this.g.setAttributeNS(null,"stroke","black"),this.g.setAttribute("type","Carrier"),this}function Battleship(n){return this.parent=n,this.g=document.createElementNS(game.svgns,"g"),this.shipPieces=this.parent.shipPieces,this.length=4,this.firstPiece=this.shipPieces[0],this.lastPiece=this.shipPieces[length],this.g.setAttributeNS(null,"id","g_Battleship"),this.g.setAttributeNS(null,"width",this.length*50+"px"),this.g.setAttributeNS(null,"height","50px"),this.g.setAttributeNS(null,"stroke","black"),this.g.setAttribute("type","Battleship"),this}function Submarine(n){return this.parent=n,this.g=document.createElementNS(game.svgns,"g"),this.shipPieces=this.parent.shipPieces,this.length=3,this.firstPiece=this.shipPieces[0],this.lastPiece=this.shipPieces[length],this.g.setAttributeNS(null,"id","g_Submarine"),this.g.setAttributeNS(null,"width",this.length*50+"px"),this.g.setAttributeNS(null,"height","50px"),this.g.setAttributeNS(null,"stroke","black"),this.g.setAttribute("type","Submarine"),this}function Cruiser(n){return this.parent=n,this.g=document.createElementNS(game.svgns,"g"),this.shipPieces=this.parent.shipPieces,this.length=3,this.firstPiece=this.shipPieces[0],this.lastPiece=this.shipPieces[length],this.g.setAttributeNS(null,"id","g_Cruiser"),this.g.setAttributeNS(null,"width",this.length*50+"px"),this.g.setAttributeNS(null,"height","50px"),this.g.setAttributeNS(null,"stroke","black"),this.g.setAttribute("type","Cruiser"),this}function Destroyer(n){return this.parent=n,this.g=document.createElementNS(game.svgns,"g"),this.shipPieces=this.parent.shipPieces,this.length=2,this.firstPiece=this.shipPieces[0],this.lastPiece=this.shipPieces[length],this.g.setAttributeNS(null,"id","g_Destroyer"),this.g.setAttributeNS(null,"width",this.length*50+"px"),this.g.setAttributeNS(null,"height","50px"),this.g.setAttributeNS(null,"stroke","black"),this.g.setAttribute("type","Destroyer"),this}function getShipLength(n){var t=-1;return ajax("GET",!1,"api/ShipType/"+n,null,function(n){t=n.ship_Length}),t}function checkForTurn(){var n=getTokenFromCookie();ajax("GET",!0,"api/Game/"+game.gameId+"/"+n,null,function(n){n.errMsg!=null?sendErrorMessage(n):(console.log("It is "+n.turn+"'s turn."),game.turn=n.turn,game.turn==game.currentPlayerId?($(".opponent-handle").removeClass("player-turn"),$(".currentPlayer-handle").addClass("player-turn")):game.turn==game.opponentPlayerId&&($(".currentPlayer-handle").removeClass("player-turn"),$(".opponent-handle").addClass("player-turn")))})}function checkForShots(){console.log("Checking for new shots...");ajax("GET",!0,"api/Shot/new-shots/"+game.lastShot+"/"+game.currentPlayerBoardId+"/"+game.opponentPlayerBoardId,null,function(n){var r,t,u,i,f;if(n.length>0)for(r=0;r<n.length;r++)t=n[r],u=t.board_Id,u==game.currentPlayerBoardId?i=document.getElementById("hole_"+t.row+"|"+t.col+"_p1"):u==game.opponentPlayerBoardId&&(i=document.getElementById("hole_"+t.row+"|"+t.col+"_p2")),t.is_Hit?(i.setAttributeNS(null,"occupied","hit"),i.setAttributeNS(null,"class","hole_hit"),i.setAttributeNS(null,"fill","red"),u==game.currentPlayerBoardId&&(f=$("rect[row="+t.col+"][col="+t.row+"]"),f[0].setAttributeNS(null,"fill","red"))):(i.setAttributeNS(null,"occupied","miss"),i.setAttributeNS(null,"class","hole_miss"),i.setAttributeNS(null,"fill","white")),game.lastShot=t.shot_Id})}function loadShips(){ajax("GET",!0,"api/Ship/all-by-board/"+game.currentPlayerBoardId,null,function(n){var i,t,r;if(n.length>0){for(i=0;i<n.length;i++)if(t=n[i],r=getShipType(t.ship_Id),r!=null)switch(r){case"Carrier":game.carrier=new Ship(document.getElementById("gId_"+game.gameId+"_p1"),"Carrier",[],t.is_Placed,t.is_Sunk);break;case"Battleship":game.battleship=new Ship(document.getElementById("gId_"+game.gameId+"_p1"),"Battleship",[],t.is_Placed,t.is_Sunk);break;case"Submarine":game.submarine=new Ship(document.getElementById("gId_"+game.gameId+"_p1"),"Submarine",[],t.is_Placed,t.is_Sunk);break;case"Cruiser":game.cruiser=new Ship(document.getElementById("gId_"+game.gameId+"_p1"),"Cruiser",[],t.is_Placed,t.is_Sunk);break;case"Destroyer":game.destroyer=new Ship(document.getElementById("gId_"+game.gameId+"_p1"),"Destroyer",[],t.is_Placed,t.is_Sunk)}game.carrier!=null&&game.battleship!=null&&game.submarine!=null&&game.cruiser!=null&&game.destroyer!=null?loadShipPieces():alert("Error loading ships, please try again.")}else alert("No ships found for game.")})}function loadShipPieces(){ajax("GET",!0,"api/ShipLocation/board/"+game.currentPlayerBoardId,null,function(n){var u;if(n.length>0){var f=0,e=0,o=0,s=0,h=0;for(u=0;u<n.length;u++){var c=n[u],t=c.row,i=c.col,r=checkForHit(t,i),l=getShipType(c.ship_Id);if(l!=null)switch(l){case"Carrier":game.carrierPieces[f]=new ShipPiece(document.getElementById("g_Carrier"),t,i,f,r);f++;break;case"Battleship":game.battleshipPieces[e]=new ShipPiece(document.getElementById("g_Battleship"),t,i,e,r);e++;break;case"Submarine":game.submarinePieces[o]=new ShipPiece(document.getElementById("g_Submarine"),t,i,o,r);o++;break;case"Cruiser":game.cruiserPieces[s]=new ShipPiece(document.getElementById("g_Cruiser"),t,i,s,r);s++;break;case"Destroyer":game.destroyerPieces[h]=new ShipPiece(document.getElementById("g_Destroyer"),t,i,h,r);h++}}game.carrier.shipPieces=game.carrierPieces;game.carrier.initialPlace();game.battleship.shipPieces=game.battleshipPieces;game.battleship.initialPlace();game.submarine.shipPieces=game.submarinePieces;game.submarine.initialPlace();game.cruiser.shipPieces=game.cruiserPieces;game.cruiser.initialPlace();game.destroyer.shipPieces=game.destroyerPieces;game.destroyer.initialPlace();$("#loading_game").remove();window.setInterval(function(){checkForTurn()},1e3);window.setInterval(function(){checkForShots()},1500)}})}function checkForHit(n,t){var i=document.getElementById("hole_"+t+"|"+n+"_p1");return $(i).hasClass("hole_hit")?!0:!1}function getShipType(n){var t,i;return ajax("GET",!1,"api/Ship/ship/"+n,null,function(n){t=n.ship_Type_Id}),ajax("GET",!1,"api/ShipType/"+t,null,function(n){i=n.ship_Type}),i}function loadShotsData(n){var t,i;n=="opponent"?(i="p2",t=game.opponentPlayerBoardId):(i="p1",t=game.currentPlayerBoardId);ajax("GET",!0,"api/Shot/all-by-board/"+t,null,function(n){var u,r,t;if(n.length>0)for(u=0;u<n.length;u++)r=n[u],t=document.getElementById("hole_"+r.row+"|"+r.col+"_"+i),r.is_Hit?(t.setAttributeNS(null,"occupied","hit"),t.setAttributeNS(null,"class","hole_hit"),t.setAttributeNS(null,"fill","red")):(t.setAttributeNS(null,"occupied","miss"),t.setAttributeNS(null,"class","hole_miss"),t.setAttributeNS(null,"fill","white")),game.lastShot=r.shot_Id})}function initializeRestartGameButton(){$("#start_over").on("click",function(n){n.preventDefault();var t=getTokenFromCookie();t!==""&&t!==null&&validToken(t)&&($("#currentPlayer-board-container").empty(),$("#opponent-board-container").empty(),$("#main-container").append("<h1> Restarting game...<\/h1>"),ajax("POST",!0,"api/Game/start-over/"+game.gameId+"/"+t,null,function(n){var u,f,s,t,i,h;if(n.errMsg!=null)sendErrorMessage(n);else{for(ajax("GET",!1,"api/Ship/all-by-board/"+game.opponentPlayerBoardId,null,function(n){u=n}),ajax("GET",!1,"api/Ship/all-by-board/"+game.currentPlayerBoardId,null,function(n){f=n}),t=0;t<u.length;t++){var r=u[t],e=r.ship_Type_Id,o=getShipLength(e);for(i=0;i<o;i++)s={Ship_Location_Id:-1,Ship_Id:r.ship_Id,Board_Id:game.opponentPlayerBoardId,Row:t,Col:i},ajax("POST",!0,"api/ShipLocation/createLocation",s,function(n){n||console.log("Error making location.")})}for(t=0;t<f.length;t++){var r=f[t],e=r.ship_Type_Id,o=getShipLength(e);for(i=0;i<o;i++)h={Ship_Location_Id:-1,Ship_Id:r.ship_Id,Board_Id:game.currentPlayerBoardId,Row:t,Col:i},ajax("POST",!0,"api/ShipLocation/createLocation",h,function(n){n?console.log("Location made."):console.log("Error making location.")})}alert("Game has been restarted.");location.reload()}}))})}function loadCurrentGame(n,t,i){ajax("GET",!1,"api/Game/"+n+"/"+t+"/"+i,null,function(t){t.errMsg!=null?sendErrorMessage(t):(game.gameId=t.game_Id,game.turn=t.turn,game.complete=t.complete,n==t.player_1_Id?(game.currentPlayerId=t.player_1_Id,game.currentPlayerBoardId=t.player_1_Board_Id,game.opponentPlayerId=t.player_2_Id,game.opponentPlayerBoardId=t.player_2_Board_Id,loadUserHandle(t.player_1_Id,"currentPlayer"),loadUserHandle(t.player_2_Id,"opponent")):n==t.player_2_Id?(game.currentPlayerId=t.player_2_Id,game.currentPlayerBoardId=t.player_2_Board_Id,game.opponentPlayerId=t.player_1_Id,game.opponentPlayerBoardId=t.player_1_Board_Id,loadUserHandle(t.player_2_Id,"currentPlayer"),loadUserHandle(t.player_1_Id,"opponent")):(alert("Invalid login credentials detected. Rerouting to main site."),window.location.href="/"),game.complete?(alert("Game has been completed. Rerouting to main site."),window.location.href="/"):(game.turn==game.currentPlayerId?$(".currentPlayer-handle").addClass("player-turn"):game.turn==game.opponentPlayerId&&$(".opponent-handle").addClass("player-turn"),game.init()))})}function loadUserHandle(n,t){ajax("GET",!0,"api/Player/by-id/"+n,null,function(n){$("."+t+"-handle").text(n.handle)})}function getURLParameter(n){return decodeURIComponent((new RegExp("[?|&]"+n+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[null,""])[1].replace(/\+/g,"%20"))||null}var game,drag,util;Cell.prototype={create:function(){var n=document.createElementNS(game.svgns,"rect");return n.setAttributeNS(null,"x",this.x+"px"),n.setAttributeNS(null,"y",this.y+"px"),n.setAttributeNS(null,"width",this.size+"px"),n.setAttributeNS(null,"height",this.size+"px"),n.setAttributeNS(null,"id",this.id),n.setAttributeNS(null,"stroke","#8d9096"),n},getMyBBox:function(){return this.object.getBBox()},getCenterX:function(){return game.BOARDX+this.x+this.size/2},getCenterY:function(){return game.BOARDY+this.y+this.size/2},placeShipPiece:function(n){this.shipPiece=n},removeShipPiece:function(){this.shipPiece=""}};Hole.prototype={create:function(){var n=document.createElementNS(game.svgns,"circle");return n.setAttributeNS(null,"cx",this.cx+"px"),n.setAttributeNS(null,"cy",this.cy+"px"),n.setAttributeNS(null,"r",10),n.setAttributeNS(null,"width",this.size+"px"),n.setAttributeNS(null,"height",this.size+"px"),n.setAttributeNS(null,"class","hole_"+this.occupied),n.setAttributeNS(null,"id",this.id),n.setAttributeNS(null,"stroke","black"),n.setAttribute("row",this.row),n.setAttribute("col",this.col),n.onclick=function(){Hole.prototype.shoot(this)},n},getMyBBox:function(){return this.object.getBBox()},getCenterX:function(){return game.BOARDX+this.x+this.size/2},getCenterY:function(){return game.BOARDY+this.y+this.size/2},shoot:function(n){var t=document.getElementById(n.id),e=t.getAttribute("row"),o=t.getAttribute("col"),i=!1,r=n.id.split("_"),u,f;console.log(r);u=r[2];game.turn==game.currentPlayerId?u=="p2"?(f={Ship_Location_Id:-1,Ship_Id:-1,Board_Id:game.opponentPlayerBoardId,Row:e,Col:o},ajax("POST",!1,"api/ShipLocation/checkHit",f,function(t){if(t.err!=null)sendErrorMessage(t);else{i=t.hit;var r=t.win;i?(Hole.prototype.hit(n),r&&(game.winningBoard=t.winningBoard,game.announceWinner())):Hole.prototype.miss(n)}})):alert("Wrong board."):alert("Not your turn.")},miss:function(n){console.log("Shot miss");var t=document.getElementById(n.id);t.setAttributeNS(null,"occupied","miss");t.setAttributeNS(null,"class","hole_miss");t.setAttributeNS(null,"fill","white")},hit:function(n){console.log("Shot hit");var t=document.getElementById(n.id);t.setAttributeNS(null,"occupied","peg");t.setAttributeNS(null,"class","hole_hit");t.setAttributeNS(null,"fill","red")}};ShipPiece.prototype={changeLocation:function(){},putOnTop:function(){document.getElementsByTagName("svg")[0].removeChild(this.piece);document.getElementsByTagName("svg")[0].appendChild(this.piece)},hit:function(){this.isHit=!0;this.setAttributeNS(null,"fill","red")},setAtt:function(n,t){this.piece.setAttributeNS(null,n,t)}};Ship.prototype={changeLocation:function(){this.firstPiece=this.shipPieces[0];this.lastPiece=this.shipPieces[length];this.g.setAttributeNS(null,"transform","translate("+this.firstPiece.row+","+this.firstPiece.col+")")},putOnTop:function(){console.log("Putting on top");document.getElementsByTagName("svg")[0].removeChild(this.g);document.getElementsByTagName("svg")[0].appendChild(this.g)},initialPlace:function(){this.firstPiece=this.shipPieces[0];this.lastPiece=this.shipPieces[length];this.g.setAttributeNS(null,"transform","translate("+this.firstPiece.row+","+this.firstPiece.col+")")},sink:function(){this.g.setAttributeNS(null,"fill","red")},setAtt:function(n,t){this.g.setAttributeNS(null,n,t)}};game={xhtmlns:"http://www.w3.org/1999/xhtml",svgns:"http://www.w3.org/2000/svg",BOARDX:0,BOARDY:0,BOARDWIDTH:10,BOARDHEIGHT:10,CELLSIZE:50,board1Arr:[],board2Arr:[],hole1Arr:[],hole2Arr:[],cruiser:null,battleship:null,destroyer:null,submarine:null,carrier:null,carrierPieces:[],battleshipPieces:[],submarinePieces:[],cruiserPieces:[],destroyerPieces:[],gameId:-1,complete:!1,currentPlayerId:-1,opponentPlayerId:-1,currentPlayerBoardId:-1,opponentPlayerBoardId:-1,lastShot:-1,turn:-1,winningBoard:-1,init:function(){for(var r=document.getElementsByTagName("svg"),t=1,i,n;t<3;)i=document.createElementNS(game.svgns,"g"),i.setAttributeNS(null,"transform","translate("+game.BOARDX+","+game.BOARDY+")"),i.setAttributeNS(null,"id","gId_"+game.gameId+"_p"+t),i.setAttributeNS(null,"fill","#b0b8c4"),r[t-1].insertBefore(i,r[t-1].childNodes[5]),t+=1;for(n=0;n<game.BOARDWIDTH;n++)for(game.board1Arr[n]=[],game.hole1Arr[n]=[],j=0;j<game.BOARDHEIGHT;j++)game.board1Arr[n][j]=new Cell(document.getElementById("gId_"+game.gameId+"_p1"),"cell_"+j+n+"_p1",game.CELLSIZE,j,n),game.hole1Arr[n][j]=new Hole(document.getElementById("gId_"+game.gameId+"_p1"),"hole_"+j+"|"+n+"_p1",20,j,n,j*50+25,n*50+25);for(n=0;n<game.BOARDWIDTH;n++)for(game.board2Arr[n]=[],game.hole2Arr[n]=[],j=0;j<game.BOARDHEIGHT;j++)game.board2Arr[n][j]=new Cell(document.getElementById("gId_"+game.gameId+"_p2"),"cell_"+j+n+"_p2",game.CELLSIZE,j,n),game.hole2Arr[n][j]=new Hole(document.getElementById("gId_"+game.gameId+"_p2"),"hole_"+j+"|"+n+"_p2",20,j,n,j*50+25,n*50+25);loadShips();loadShotsData("currentPlayer");loadShotsData("opponent");document.getElementsByTagName("svg")[0].addEventListener("mouseup",drag.releaseMove,!1);document.getElementsByTagName("svg")[0].addEventListener("mousemove",drag.go,!1);initializeRestartGameButton()},announceWinner:function(){var n=getTokenFromCookie();n!==""&&n!==null&&validToken(n)&&ajax("GET",!0,"api/Game/"+gameId+"/"+n,null,function(n){n.complete==1&&(game.winningBoard==game.currentPlayerBoardId?$("#main-container").apend("<h1>Winner: "+$(".currentPlayer-handle").val()+"<\/h1>"):game.winningBoard==game.opponentPlayerBoardId&&$("#main-container").apend("<h1>Winner: "+$(".opponent-handle").val()+"<\/h1>"))})}};drag={ship:null,shipId:"",shipX:"",shipY:"",shipLength:"",shipPiecesCount:"",g:null,setMove:function(n){switch(n){case"Carrier":console.log("Carrier selected...");drag.ship=document.getElementById("g_Carrier");drag.shipId="g_Carrier";drag.g=game.carrier;break;case"Battleship":console.log("Battleship selected...");drag.ship=document.getElementById("g_Battleship");drag.shipId="g_Battleship";drag.g=game.battleship;break;case"Submarine":console.log("Submarine selected...");drag.ship=document.getElementById("g_Submarine");drag.shipId="g_Submarine";drag.g=game.submarine;break;case"Cruiser":console.log("Cruiser selected...");drag.ship=document.getElementById("g_Cruiser");drag.shipId="g_Cruiser";drag.g=game.cruiser;break;case"Destroyer":console.log("Destroyer selected...");drag.ship=document.getElementById("g_Destroyer");drag.shipId="g_Destroyer";drag.g=game.destroyer}xy=util.getTransform(drag.shipId);drag.shipX=xy[0];drag.shipY=xy[1];drag.shipLength=drag.ship.getAttribute("width");drag.shipPiecesCount=drag.shipLength/50;drag.g.putOnTop()},releaseMove:function(){drag.mover!=""&&(drag.ship=null,drag.g=null)},go:function(n){drag.ship!=null&&util.setTransform(drag.shipId,n.layerX,n.layerY)}};$(document).ready(function(){var n=getTokenFromCookie(),t,i,r;n!==""&&n!==null?validToken(n)?(console.log("Valid login credentials detected! Loading game..."),t=getUserIdFromToken(n),console.log("Logged in user id for game: "+t),i=getURLParameter("p1"),r=getURLParameter("p2"),t==i?loadCurrentGame(t,r,n):t==r?loadCurrentGame(t,i,n):(alert("You are not a player for this game. Rerouting to main site."),window.location.href="/")):(alert("Invalid login credentials detected. Rerouting to main site"),window.location.href="/"):(alert("No login credentials detected - Please login again. Rerouting to main site."),window.location.href="/")});util={getPiece:function(n){return game.pieceArr[parseInt(n.substr(n.search(/\_/)+1,1))][parseInt(n.substring(n.search(/\|/)+1,n.length))]},getTransform:function(n){var t=document.getElementById(n).getAttributeNS(null,"transform"),i=[];return i[0]=t.substring(t.search(/\(/)+1,t.search(/,/)),i[1]=t.substring(t.search(/,/)+1,t.search(/\)/)),i},setTransform:function(n,t,i){document.getElementById(n).setAttributeNS(null,"transform","translate("+t+","+i+")")},changeTurn:function(){},nytwarning:function(){},nypwarning:function(){}};